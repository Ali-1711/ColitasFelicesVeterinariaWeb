<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Cl铆nica y Veterinaria Colitas Felices</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />


</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Barra superior -->
  <header
    class="h-16 bg-green-900 text-white py-4 px-6 flex justify-between items-center w-full fixed top-0 z-20 shadow-lg">
    <div class="flex items-center gap-4">
      <button onclick="toggleSidebar()" class="md:hidden text-white focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <h1 class="text-xl font-bold">Cl铆nica Veterinaria Puente Blanco</h1>
    </div>
  </header>


  <div class="flex w-full min-h-screen">
    <aside id="sidebar" class="fixed top-[64px] md:top-16 left-0 w-64 h-screen bg-gray-800 text-white flex flex-col justify-between z-20
              transform md:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out">
      <div>
        <nav class="flex flex-col p-4 space-y-4">
          <!-- Dashboard -->
          <a th:href="@{/dashboard}" class="flex items-center gap-3 text-green-400 bg-gray-700 p-2 rounded">
            <i class="fa-solid fa-table-columns"></i>
            Dashboard
          </a>

          <!-- Agendar Cita -->
          <a th:href="@{/book-appointment}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700">
            <i class="fa-solid fa-calendar-days"></i>
            Agendar Cita
          </a>

          <!-- Ver Citas -->
          <a th:href="@{/appointments}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"><i
              class="fa-solid fa-clock"></i>
            Ver Citas
          </a>

          <!-- Cancelar Cita -->
          <a th:href="@{/cancel-appointment}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"><i
              class="fa-solid fa-calendar-xmark"></i>
            Cancelar Cita
          </a>

          <!-- Veterinarios -->
          <a th:href="@{/veterinarians}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"><i
              class="fa-solid fa-stethoscope"></i>
            Veterinarios
          </a>

          <!-- Vacunaci贸n -->
          <a th:href="@{/vaccination}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700">
            <i class="fa-solid fa-syringe"></i>
            Vacunaci贸n
          </a>
          <!-- Bot贸n de cierre de sesi贸n -->
          <button onclick="logout()"
            class="m-4 flex items-center justify-center gap-2 bg-gray-100 text-red-500 px-4 py-2 rounded hover:bg-gray-200">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar Sesi贸n
          </button>
        </nav>
      </div>
    </aside>

    <main class="flex-1 bg-gray-100 min-h-screen pt-24 md:pt-24 ml-0 md:ml-64 flex justify-center items-start px-4">
      <div class="bg-white w-full max-w-xl shadow-xl rounded-2xl border-t-8 border-yellow-500 p-8">
        <h2 class="text-3xl font-extrabold text-center text-gray-800 mb-8"> Reservar Cita</h2>
        <form id="appointmentForm" class="space-y-6">
          <!-- Mascota -->
          <div>
            <label for="pet" class="block text-sm font-semibold text-gray-700 mb-1">Mascota</label>
            <select id="pet" name="petId" required
              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:outline-none shadow-sm">
              <option disabled selected>Seleccione una mascota</option>
            </select>
          </div>

          <!-- Servicio -->
          <div>
            <label for="servicio" class="block text-sm font-semibold text-gray-700 mb-1">Servicio</label>
            <select id="servicio" name="servicioId" required
              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:outline-none shadow-sm">
              <option disabled selected>Seleccione un servicio</option>
            </select>
          </div>

          <!-- Veterinario -->
          <div>
            <label for="veterinario" class="block text-sm font-semibold text-gray-700 mb-1">Veterinario</label>
            <select id="veterinario" name="veterinarioId" required
              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:outline-none shadow-sm">
              <option disabled selected>Seleccione un veterinario</option>
            </select>
          </div>

          <!-- Fecha -->
          <div>
            <label for="fecha" class="block text-sm font-semibold text-gray-700 mb-1">Fecha</label>
            <input type="date" id="fecha" name="fecha" required
              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:outline-none shadow-sm" />
          </div>

          <!-- Hora -->
          <div id="horaContainer" class="hidden">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Seleccione una hora</label>
            <div id="slots" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
          </div>
          <input type="hidden" id="horaSeleccionada" name="hora" required />

            <!-- Correo -->
            <div>
                <label for="email" class="block text-sm font-semibold text-gray-700 mb-1">Correo electr贸nico</label>
                <input type="email" id="email" name="email" required
                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:outline-none shadow-sm"
                       placeholder="tu_correo@ejemplo.com">
            </div>


            <!-- Bot贸n -->
          <div>
            <button type="submit" id="submitBtn"
              class="w-full flex items-center justify-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 rounded-lg shadow-md transition transform hover:scale-105">
              <i class="fa-solid fa-calendar-check"></i> Reservar Cita
            </button>
          </div>
        </form>

        <!-- Mensaje -->
        <div id="mensaje" class="text-center mt-4 text-sm font-medium text-green-600"></div>
      </div>
    </main>

    <!-- JS Script -->
    <script>
      // Funci贸n para obtener una fecha/hora simulada
      function getMockedDate() {
        return new Date("2025-06-23T10:30:00");
      }

      document.addEventListener('DOMContentLoaded', () => {
        // Establecer el valor m铆nimo para la fecha como la fecha actual
        const today = new Date().toISOString().split('T')[0];
        const fechaInput = document.getElementById('fecha');
        fechaInput.setAttribute('min', today);

        // Mensaje personalizado de validaci贸n para la fecha
        fechaInput.addEventListener('input', function () {
          const minDate = fechaInput.getAttribute('min');
          if (fechaInput.value < minDate) {
            fechaInput.setCustomValidity("Por favor, selecciona una fecha a partir de hoy o posterior.");
          } else {
            fechaInput.setCustomValidity("");
          }
        });

        // Cargar mascotas del cliente
        fetch('/api/client/pets')
          .then(res => res.json())
          .then(data => {
            const petSelect = document.getElementById('pet');
            data.forEach(pet => {
              const option = document.createElement('option');
              option.value = pet.id;
              option.textContent = `${pet.name} (${pet.breed})`;
              petSelect.appendChild(option);
            });
          });

        // Cargar servicios
        fetch('/api/client/services')
          .then(res => res.json())
          .then(data => {
            const servicioSelect = document.getElementById('servicio');
            data.forEach(servicio => {
              const option = document.createElement('option');
              option.value = servicio.id;
              option.textContent = servicio.nombre || servicio.descripcion || 'Servicio';
              servicioSelect.appendChild(option);
            });
          });

        // Cargar veterinarios
        fetch('/api/client/veterinarians')
          .then(res => res.json())
          .then(data => {
            const veterinarioSelect = document.getElementById('veterinario');
            data.forEach(vet => {
              const option = document.createElement('option');
              option.value = vet.id;
              option.textContent = vet.nombreCompleto;
              veterinarioSelect.appendChild(option);
            });
          });
      });

      // Cargar horarios disponibles
      document.getElementById('fecha').addEventListener('change', cargarHorarios);
      document.getElementById('veterinario').addEventListener('change', cargarHorarios);

      function cargarHorarios() {
        const veterinarioId = document.getElementById('veterinario').value;
        const fecha = document.getElementById('fecha').value;

        if (!veterinarioId || !fecha) return;

        fetch(`/api/client/veterinarians/${veterinarioId}/horarios?fecha=${fecha}`)
          .then(res => res.json())
          .then(horasDisponibles => {
            const contenedor = document.getElementById('slots');
            contenedor.innerHTML = '';
            document.getElementById('horaContainer').classList.remove('hidden');

            if (horasDisponibles.length === 0) {
              contenedor.innerHTML = '<p class="text-gray-600 col-span-3">No hay horarios disponibles para esta fecha.</p>';
              return;
            }

            const currentTime = new Date();
            const currentHour = currentTime.getHours();
            const currentMinutes = currentTime.getMinutes();
            const esHoy = fecha === currentTime.toISOString().split('T')[0];

            horasDisponibles.forEach(hora => {
              const [horaSlot, minutosSlot] = hora.split(':').map(Number);

              // Deshabilitar horas pasadas solo si la cita es para hoy
              if (esHoy && (horaSlot < currentHour || (horaSlot === currentHour && minutosSlot <= currentMinutes))) {
                return;
              }

              const btn = document.createElement('button');
              btn.type = "button";
              btn.textContent = hora;
              btn.className = "border rounded px-4 py-2 bg-white hover:bg-blue-100";
              btn.onclick = () => {
                document.querySelectorAll('#slots button').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
                btn.classList.add('bg-blue-500', 'text-white');
                document.getElementById('horaSeleccionada').value = hora;
              };
              contenedor.appendChild(btn);
            });
          })
          .catch(() => {
            document.getElementById('slots').innerHTML = '<p class="text-red-500">Error al cargar horarios.</p>';
          });
      }

      // Enviar cita con protecci贸n contra m煤ltiples clics
      document.getElementById('appointmentForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
        <span class="inline-flex items-center">
          <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Procesando...
        </span>
      `;

        const data = {
          petId: document.getElementById('pet').value,
          servicioId: document.getElementById('servicio').value,
          veterinarioId: document.getElementById('veterinario').value,
          fecha: document.getElementById('fecha').value,
          hora: document.getElementById('horaSeleccionada').value,
          email: document.getElementById('email').value

        };

        fetch('/api/client/appointments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
          .then(res => {
            if (!res.ok) throw new Error('Error al registrar la cita');
            return res.text();
          })
          .then(msg => {
            Swal.fire({
              icon: 'success',
              title: '隆Cita registrada!',
              text: msg || 'Tu cita ha sido reservada exitosamente.',
              confirmButtonColor: '#10b981'
            }).then(() => {
              document.getElementById('appointmentForm').reset();
              document.getElementById('slots').innerHTML = '';
              document.getElementById('horaContainer').classList.add('hidden');
            });
          })

          .catch(err => {
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: err.message || 'No se pudo registrar la cita.',
              confirmButtonColor: '#ef4444'
            });
          })

          .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = "Reservar Cita";
          });
      });

      function logout() {
        document.cookie = "jwt=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax";
        window.location.href = "/";
      }

      //OCULTAR SIDEBAR TIPO HAMBURGUESITA

      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('-translate-x-full');
      }

      // Cerrar sidebar al hacer clic en enlaces (solo en m贸vil)
      document.addEventListener('DOMContentLoaded', () => {
        const links = document.querySelectorAll('#sidebar a');
        links.forEach(link => {
          link.addEventListener('click', () => {
            if (window.innerWidth < 768) {
              document.getElementById('sidebar').classList.add('-translate-x-full');
            }
          });
        });

        // Cerrar si se hace clic fuera del sidebar en m贸vil
        document.addEventListener('click', (e) => {
          const sidebar = document.getElementById('sidebar');
          const toggleBtn = document.querySelector('button[onclick="toggleSidebar()"]');

          if (
            window.innerWidth < 768 &&
            !sidebar.contains(e.target) &&
            !toggleBtn.contains(e.target)
          ) {
            sidebar.classList.add('-translate-x-full');
          }
        });
      });
    </script>
</body>

</html>