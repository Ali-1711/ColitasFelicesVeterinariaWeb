<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Cl√≠nica y Veterinaria Colitas Felices</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />


</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Barra superior -->
  <header
    class="h-16 bg-green-900 text-white py-4 px-6 flex justify-between items-center w-full fixed top-0 z-20 shadow-lg">
    <div class="flex items-center gap-4">
      <button onclick="toggleSidebar()" class="md:hidden text-white focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <h1 class="text-xl font-bold">Colitas Felices</h1>
    </div>
    <span th:text="'Bienvenido, ' + ${dashboard.fullName}" class="text-sm md:text-base"></span>
  </header>


  <!-- Sidebar -->
  <div class="flex w-full min-h-screen">
    <aside id="sidebar" class="fixed top-[64px] md:top-16 left-0 w-64 h-screen bg-gray-800 text-white flex flex-col justify-between z-20
              transform md:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out">
      <div>
        <nav class="flex flex-col p-4 space-y-4">
          <!-- Dashboard -->
          <a th:href="@{/dashboard}" class="flex items-center gap-3 text-green-400 bg-gray-700 p-2 rounded">
            <i class="fa-solid fa-table-columns"></i>
            Dashboard
          </a>

          <!-- Agendar Cita -->
          <a th:href="@{/book-appointment}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700">
            <i class="fa-solid fa-calendar-days"></i>
            Agendar Cita
          </a>

          <!-- Ver Citas -->
          <a th:href="@{/appointments}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"><i
              class="fa-solid fa-clock"></i>
            Ver Citas
          </a>

          <!-- Cancelar Cita -->
          <a th:href="@{/cancel-appointment}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"><i
              class="fa-solid fa-calendar-xmark"></i>
            Cancelar Cita
          </a>

          <!-- Veterinarios -->
          <a th:href="@{/veterinarians}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"><i
              class="fa-solid fa-stethoscope"></i>
            Veterinarios
          </a>

          <!-- Vacunaci√≥n -->
          <a th:href="@{/vaccination}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700">
            <i class="fa-solid fa-syringe"></i>
            Vacunaci√≥n
          </a>
          <!-- Bot√≥n de cierre de sesi√≥n -->
          <button onclick="logout()"
            class="m-4 flex items-center justify-center gap-2 bg-gray-100 text-red-500 px-4 py-2 rounded hover:bg-gray-200">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar Sesi√≥n
          </button>
        </nav>
      </div>
    </aside>



    <!-- Contenido principal -->
    <main class="flex-1 bg-gray-100 min-h-screen flex justify-center items-start pt-24 px-4 md:pl-64">
      <div class="w-full max-w-xl bg-white shadow-xl rounded-2xl border-t-8 border-red-600 p-8">
        <h2 class="text-3xl font-extrabold text-center text-gray-800 mb-8">‚ùå Cancelar Cita</h2>
        <form id="cancelForm" class="space-y-6">
          <!-- Selecci√≥n de Cita -->
          <div>
            <label for="appointmentSelect" class="block text-sm font-semibold text-gray-700 mb-1">Seleccione una
              cita:</label>
            <select id="appointmentSelect" required
              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none shadow-sm">
              <option disabled selected>Seleccione una cita para cancelar</option>
            </select>
          </div>

          <!-- Motivo -->
          <div>
            <label for="reason" class="block text-sm font-semibold text-gray-700 mb-1">Motivo de cancelaci√≥n:</label>
            <textarea id="reason" rows="3" required
              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none shadow-sm resize-none"
              placeholder="Escriba el motivo..."></textarea>
          </div>

          <!-- Bot√≥n -->
          <div>
            <button type="submit"
              class="w-full bg-red-600 hover:bg-red-700 transition text-white font-semibold py-2 rounded-lg shadow-md flex justify-center items-center gap-2 hover:scale-[1.02]">
              <i class="fa-solid fa-ban"></i> Cancelar Cita
            </button>
          </div>
        </form>

        <!-- Mensaje -->
        <div id="mensaje" class="text-center mt-4 text-sm font-medium text-green-600"></div>
      </div>
    </main>
  </div>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    const token = getCookie("jwt");

    // Cargar citas disponibles
    fetch("/api/client/cancel-appointments", { method: "GET", credentials: "include" })
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("appointmentSelect");
        data.forEach(cita => {
          const option = document.createElement("option");
          option.value = cita.id;
          option.textContent = `üìÖ ${cita.fecha} ${cita.hora} - ${cita.veterinario} (${cita.servicio})`;
          select.appendChild(option);
        });
      });

    // Cancelar cita con motivo
    document.getElementById("cancelForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const id = document.getElementById("appointmentSelect").value;
      const motivo = document.getElementById("reason").value.trim();

      if (!motivo) {
        alert("Por favor ingrese un motivo de cancelaci√≥n.");
        return;
      }

      const response = await fetch(`/api/client/cancel-appointments/${id}/cancel`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ motivoCancelacion: motivo })
      });

      if (response.ok) {
        Swal.fire({
          icon: 'success',
          title: '¬°Cita cancelada!',
          text: 'La cita ha sido cancelada exitosamente.',
          confirmButtonColor: '#dc2626'
        }).then(() => {
          const select = document.getElementById("appointmentSelect");
          select.remove(select.selectedIndex);
          document.getElementById("reason").value = "";
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'No se pudo cancelar la cita. Intenta nuevamente.',
          confirmButtonColor: '#ef4444'
        });
      }

    });

    function logout() {
      document.cookie = "jwt=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax";
      window.location.href = "/";
    }
    //OCULTAR SIDEBAR TIPO HAMBURGUESITA

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('-translate-x-full');
    }

    // Cerrar sidebar al hacer clic en enlaces (solo en m√≥vil)
    document.addEventListener('DOMContentLoaded', () => {
      const links = document.querySelectorAll('#sidebar a');
      links.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 768) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
          }
        });
      });

      // Cerrar si se hace clic fuera del sidebar en m√≥vil
      document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.querySelector('button[onclick="toggleSidebar()"]');

        if (
          window.innerWidth < 768 &&
          !sidebar.contains(e.target) &&
          !toggleBtn.contains(e.target)
        ) {
          sidebar.classList.add('-translate-x-full');
        }
      });
    });
  </script>

</body>

</html>