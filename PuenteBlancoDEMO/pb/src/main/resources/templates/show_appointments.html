<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
  <meta charset="UTF-8" />
  <title>ClÃ­nica y Veterinaria Colitas Felices</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Barra superior -->
  <header
    class="h-16 bg-green-900 text-white py-4 px-6 flex justify-between items-center w-full fixed top-0 z-20 shadow-lg">
    <div class="flex items-center gap-4">
      <button onclick="toggleSidebar()" class="md:hidden text-white focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <h1 class="text-xl font-bold">ClÃ­nica Veterinaria Puente Blanco</h1>
    </div>
  </header>

  <div class="flex w-full min-h-screen">
    <aside id="sidebar" class="fixed top-[64px] md:top-16 left-0 w-64 h-screen bg-gray-800 text-white flex flex-col justify-between z-20
              transform md:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out">
      <div>
        <nav class="flex flex-col p-4 space-y-4">
          <!-- Dashboard -->
          <a th:href="@{/dashboard}" class="flex items-center gap-3 text-green-400 bg-gray-700 p-2 rounded">
            <i class="fa-solid fa-table-columns"></i>
            Dashboard
          </a>

          <!-- Agendar Cita -->
          <a th:href="@{/book-appointment}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700">
            <i class="fa-solid fa-calendar-days"></i>
            Agendar Cita
          </a>

          <!-- Ver Citas -->
          <a th:href="@{/appointments}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"><i
              class="fa-solid fa-clock"></i>
            Ver Citas
          </a>

          <!-- Cancelar Cita -->
          <a th:href="@{/cancel-appointment}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"><i
              class="fa-solid fa-calendar-xmark"></i>
            Cancelar Cita
          </a>

          <!-- Veterinarios -->
          <a th:href="@{/veterinarians}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700"><i
              class="fa-solid fa-stethoscope"></i>
            Veterinarios
          </a>

          <!-- VacunaciÃ³n -->
          <a th:href="@{/vaccination}" class="flex items-center gap-3 p-2 rounded hover:bg-gray-700">
            <i class="fa-solid fa-syringe"></i>
            VacunaciÃ³n
          </a>
          <!-- BotÃ³n de cierre de sesiÃ³n -->
          <button onclick="logout()"
            class="m-4 flex items-center justify-center gap-2 bg-gray-100 text-red-500 px-4 py-2 rounded hover:bg-gray-200">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar SesiÃ³n
          </button>
        </nav>
      </div>
    </aside>


    <!-- Contenido principal -->
    <main class="flex-1 p-4 sm:p-6 md:p-10 pt-24 md:pt-24 ml-0 md:ml-64 bg-gray-100 min-h-screen font-sans">
      <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-800 mb-6 text-center"> ğŸ“‹ Historial de Citas </h2>
      <!-- Filtros -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"> <input type="text" id="searchInput"
          placeholder="ğŸ” Buscar..." class="px-4 py-2 border rounded shadow w-full" /> <select id="filterMascota"
          class="px-4 py-2 border rounded shadow w-full">
          <option value="">ğŸ¾ Todas las Mascotas</option>
        </select> <select id="filterVeterinario" class="px-4 py-2 border rounded shadow w-full">
          <option value="">ğŸ‘¨â€âš•ï¸ Todos los Veterinarios</option>
        </select> <input type="date" id="filterFecha" class="px-4 py-2 border rounded shadow w-full" /> </div>
      <!-- Tabla Desktop | Oculta en mÃ³vil -->
      <div class="hidden md:block overflow-x-auto bg-white rounded-xl shadow-lg">
        <table class="min-w-full divide-y divide-gray-200 text-sm text-left font-medium">
          <thead class="bg-yellow-100 text-gray-800 uppercase text-xs tracking-wider">
            <tr>
              <th class="px-6 py-3">ğŸ“… Fecha y hora</th>
              <th class="px-6 py-3">ğŸ¶ Mascota</th>
              <th class="px-6 py-3">ğŸ’‰ Servicio</th>
              <th class="px-6 py-3">ğŸ‘¨â€âš•ï¸ Veterinario</th>
              <th class="px-6 py-3">ğŸ“Œ Estado</th>
              <th class="px-6 py-3 text-center">AcciÃ³n</th>
            </tr>
          </thead>
          <tbody id="appointmentTableBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
        </table>
      </div> <!-- Tarjetas Mobile | Oculto en desktop -->
      <div id="appointmentCardsContainer" class="md:hidden space-y-4"></div>
    </main> <!-- Modal -->
    <div id="reasonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm text-center">
        <h2 class="text-lg font-bold mb-4">Motivo de cancelaciÃ³n</h2>
        <p id="modalReasonText" class="mb-4 text-gray-700"></p> <button onclick="closeModal()"
          class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 w-full transition"> Cerrar </button>
      </div>
    </div>

    <!-- Modal -->
    <div id="reasonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded shadow-lg max-w-sm text-center">
        <h2 class="text-lg font-bold mb-4">Motivo de cancelaciÃ³n</h2>
        <p id="modalReasonText" class="mb-4 text-gray-700"></p>
        <button onclick="closeModal()"
          class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800">Cerrar</button>
      </div>
    </div>

    <script>
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      const token = getCookie("jwt");
      function renderMobileCards(data) {
        const container = document.getElementById("appointmentCardsContainer");
        if (!container) return;
        container.innerHTML = "";

        data.forEach(cita => {
          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded-lg shadow";
          card.innerHTML = `
  <div class="flex justify-between items-center mb-2">
    <span class="text-sm text-gray-500">${cita.fecha} ${cita.hora}</span>
    <span class="text-xs ${cita.estado === "CANCELADA" ? "bg-red-100 text-red-600" : cita.estado === "FINALIZADA" ? "bg-green-100 text-green-600" : "bg-blue-100 text-blue-600"} px-2 py-1 rounded-full">
      ${cita.estado}
    </span>
  </div>
  <p class="text-gray-700"><strong>Mascota:</strong> ${cita.mascota}</p>
  <p class="text-gray-700"><strong>Servicio:</strong> ${cita.servicio}</p>
  <p class="text-gray-700"><strong>Veterinario:</strong> ${cita.veterinario}</p>
  <div class="mt-2 text-right">
    ${cita.estado === "CANCELADA" && cita.motivoCancelacion
              ? `<button onclick="showReason('${cita.motivoCancelacion.replace(/'/g, "\\'")}')" class="text-blue-600 underline text-sm">Ver motivo</button>`
              : `<span class="text-gray-400 text-sm">-</span>`}
  </div>
`;

          container.appendChild(card);
        });
      }


      fetch("/api/client/appointments", { credentials: "include" })
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("appointmentTableBody");
          const mascotaSelect = document.getElementById("filterMascota");
          const vetSelect = document.getElementById("filterVeterinario");

          tbody.innerHTML = "";

          const mascotasSet = new Set();
          const veterinariosSet = new Set();
          // al final del fetch
          renderMobileCards(data);
          data.reverse().forEach(cita => {
            mascotasSet.add(cita.mascota);
            veterinariosSet.add(cita.veterinario);

            const tr = document.createElement("tr");
            tr.setAttribute("data-mascota", cita.mascota.toLowerCase());
            tr.setAttribute("data-veterinario", cita.veterinario.toLowerCase());
            tr.setAttribute("data-fecha", cita.fecha);
            tr.innerHTML = `
    <td class="px-6 py-4 whitespace-nowrap">${cita.fecha} ${cita.hora}</td>
    <td class="px-6 py-4 whitespace-nowrap">${cita.mascota}</td>
    <td class="px-6 py-4 whitespace-nowrap">${cita.servicio}</td>
    <td class="px-6 py-4 whitespace-nowrap">${cita.veterinario}</td>
    <td class="px-6 py-4 whitespace-nowrap">${renderStatusBadge(cita.estado)}</td>
    <td class="px-6 py-4 whitespace-nowrap text-center">${renderActionButton(cita)}</td>
  `;
            tbody.appendChild(tr);
          });

          mascotasSet.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            mascotaSelect.appendChild(opt);
          });

          veterinariosSet.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            vetSelect.appendChild(opt);
          });
        });

      function applyFilters() {
        const search = document.getElementById("searchInput").value.toLowerCase();
        const mascota = document.getElementById("filterMascota").value.toLowerCase();
        const veterinario = document.getElementById("filterVeterinario").value.toLowerCase();
        const fecha = document.getElementById("filterFecha").value;

        const rows = document.querySelectorAll("#appointmentTableBody tr");

        rows.forEach(row => {
          const text = row.innerText.toLowerCase();
          const rowMascota = row.getAttribute("data-mascota");
          const rowVet = row.getAttribute("data-veterinario");
          const rowFecha = row.getAttribute("data-fecha");
          const matchesSearch = text.includes(search);
          const matchesMascota = !mascota || rowMascota === mascota;
          const matchesVet = !veterinario || rowVet === veterinario;
          const matchesFecha = !fecha || rowFecha === fecha;

          row.style.display = matchesSearch && matchesMascota && matchesVet && matchesFecha ? "" : "none";

        });
      }
      ["searchInput", "filterMascota", "filterVeterinario", "filterFecha"].forEach(id => {
        document.getElementById(id).addEventListener("input", applyFilters);
      });

      function renderStatusBadge(status) {
        switch (status) {
          case "REGISTRADA":
            return `<span class="text-blue-600 border border-blue-600 px-2 py-1 rounded-full text-xs">Registrada</span>`;
          case "FINALIZADA":
            return `<span class="text-green-600 bg-green-100 px-2 py-1 rounded-full text-xs">Finalizada</span>`;
          case "CANCELADA":
            return `<span class="text-red-600 bg-red-100 px-2 py-1 rounded-full text-xs">Cancelada</span>`;
          default:
            return `<span class="text-gray-600 bg-gray-100 px-2 py-1 rounded-full text-xs">${status}</span>`;
        }
      }

      function renderActionButton(cita) {
        if (cita.estado === "CANCELADA" && cita.motivoCancelacion) {
          return `<button onclick="showReason('${cita.motivoCancelacion.replace(/'/g, "\\'")}')" class="text-blue-700 underline">Ver motivo</button>`;
        } else {
          return `<span class="text-gray-400 text-xs">-</span>`;
        }
      }

      function showReason(reason) {
        document.getElementById("modalReasonText").innerText = reason;
        document.getElementById("reasonModal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("reasonModal").classList.add("hidden");
      }

      function logout() {
        document.cookie = "jwt=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax";
        window.location.href = "/";
      }

      document.getElementById("searchInput").addEventListener("input", function () {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll("#appointmentTableBody tr");

        rows.forEach(row => {
          const text = row.innerText.toLowerCase();
          row.style.display = text.includes(searchValue) ? "" : "none";
        });
      });
      //OCULTAR SIDEBAR TIPO HAMBURGUESITA

      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('-translate-x-full');
      }

      // Cerrar sidebar al hacer clic en enlaces (solo en mÃ³vil)
      document.addEventListener('DOMContentLoaded', () => {
        const links = document.querySelectorAll('#sidebar a');
        links.forEach(link => {
          link.addEventListener('click', () => {
            if (window.innerWidth < 768) {
              document.getElementById('sidebar').classList.add('-translate-x-full');
            }
          });
        });

        // Cerrar si se hace clic fuera del sidebar en mÃ³vil
        document.addEventListener('click', (e) => {
          const sidebar = document.getElementById('sidebar');
          const toggleBtn = document.querySelector('button[onclick="toggleSidebar()"]');

          if (
            window.innerWidth < 768 &&
            !sidebar.contains(e.target) &&
            !toggleBtn.contains(e.target)
          ) {
            sidebar.classList.add('-translate-x-full');
          }
        });
      });

    </script>

</body>

</html>